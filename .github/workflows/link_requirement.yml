# SPDX-FileCopyrightText: 2025 Contributors to the Media eXchange Layer project.
# SPDX-License-Identifier: Apache-2.0

name: Link Requirement Issue

on:
  issues:
    types: [opened, edited]

  # Permanent test mode — can be run manually from Actions tab:
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to test with (Feature issue)"
        required: true
        type: number

permissions:
  contents: read
  issues: write
  repository-projects: write

jobs:
  link-requirement:
    # Run when:
    # - a real Feature issue fires the issues webhook, OR
    # - the workflow is manually triggered via workflow_dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.issue.type == 'Feature' ||
      github.event.issue.type.name == 'Feature'
    runs-on: ubuntu-latest
    env:
      # Default repo for number-only requirement links
      DEFAULT_REQUIREMENTS_REPO: ${{ vars.DEFAULT_REQUIREMENTS_REPO || 'dmf-mxl/mxl-requirements' }}

      # Unified ISSUE_NUMBER:
      # • issues event → github.event.issue.number
      # • dispatch event → inputs.issue_number
      ISSUE_NUMBER: ${{ github.event.issue.number || inputs.issue_number }}

    steps:
      #
      # 1. Fetch full issue body (works for both real issues and workflow_dispatch)
      #
      - name: Fetch issue body
        id: fetch
        run: |
          echo "Fetching issue body for issue #${ISSUE_NUMBER}"
          gh api "repos/${{ github.repository }}/issues/${ISSUE_NUMBER}" --jq .body > issue_body.txt

      #
      # 2. Try to parse the form (will only succeed on real Feature issues)
      #
      - name: Parse issue form (best effort)
        id: parse
        uses: cssnr/parse-issue-form-action@v1
        continue-on-error: true
        with:
          body: ${{ steps.fetch.outputs.body || github.event.issue.body || '' }}

      #
      # 3. Guard – ensure requirement_link exists (only used for real issues)
      #
      - name: Guard – ensure requirement_link exists
        id: guard
        run: |
          LINK="${{ steps.parse.outputs.requirement_link }}"
          if [ -z "$LINK" ]; then
            # In test mode, warn instead of skipping
            if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
              echo "WARNING: No requirement_link found. Test mode continues."
              echo "has=true" >> $GITHUB_OUTPUT
            else
              echo "has=false" >> $GITHUB_OUTPUT
              echo "Requirement link missing — skipping."
            fi
          else
            echo "has=true" >> $GITHUB_OUTPUT
          fi

      #
      # 4. Normalise requirement link (only when guard passes)
      #
      - name: Normalize requirement link
        if: steps.guard.outputs.has == 'true'
        id: extract
        env:
          RAW_LINK: ${{ steps.parse.outputs.requirement_link }}
          DEFAULT_REPO: ${{ env.DEFAULT_REQUIREMENTS_REPO }}
        run: |
          set -euo pipefail

          if [ -z "${RAW_LINK:-}" ]; then
            echo "RAW_LINK missing (test mode?) — skipping normalisation."
            exit 0
          fi

          LINK="$(echo "$RAW_LINK" | tr -d '\r' | xargs)"
          OWNER_REPO=""
          ISSUE_NUM=""
          FULL_URL=""

          # owner/repo#99999
          if [[ "$LINK" =~ ^[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+#[0-9]+$ ]]; then
            OWNER_REPO="${LINK%%#*}"
            ISSUE_NUM="${LINK##*#}"

          # number-only: 99999 or #99999
          elif [[ "$LINK" =~ ^\#?[0-9]+$ ]]; then
            OWNER_REPO="$DEFAULT_REPO"
            ISSUE_NUM="${LINK#\#}"

          # full URL format
          elif [[ "$LINK" =~ ^https?://github\.com/([^/]+)/([^/]+)/issues/([0-9]+) ]]; then
            OWNER_REPO="${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
            ISSUE_NUM="${BASH_REMATCH[3]}"

          else
            echo "Invalid requirement link format: $LINK"
          fi

          if [[ -n "$OWNER_REPO" && -n "$ISSUE_NUM" ]]; then
            FULL_URL="https://github.com/${OWNER_REPO}/issues/${ISSUE_NUM}"
            echo "owner_repo=$OWNER_REPO"     >> $GITHUB_OUTPUT
            echo "issue_num=$ISSUE_NUM"      >> $GITHUB_OUTPUT
            echo "requirement_url=$FULL_URL" >> $GITHUB_OUTPUT
            echo "Normalized URL: $FULL_URL"
          fi

      #
      # 5. Create GitHub App token (real use)
      #
      - name: Create GitHub App token (org)
        if: steps.extract.outputs.issue_num != '' && github.event_name != 'workflow_dispatch'
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.CROSS_REPO_ISSUE_ACCESS_APP_ID }}
          private-key: ${{ secrets.CROSS_REPO_ISSUE_ACCESS_PRIVATE_KEY }}
          owner: dmf-mxl

      - name: Export GH_TOKEN
        if: steps.extract.outputs.issue_num != '' && github.event_name != 'workflow_dispatch'
        run: |
          echo "GH_TOKEN=${{ steps.app-token.outputs.token }}" >> "$GITHUB_ENV"

      #
      # 6. Allow test mode to use GITHUB_TOKEN instead
      #
      - name: Test mode token
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "GH_TOKEN=${{ secrets.GITHUB_TOKEN }}" >> "$GITHUB_ENV"

      - name: Verify GH_TOKEN
        if: steps.extract.outputs.issue_num != ''
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "ERROR: GH_TOKEN empty"
            exit 1
          fi

      #
      # 7. Parent–child link (Requirement parent → Feature child)
      #
      - name: Link as sub-issue
        if: steps.extract.outputs.issue_num != ''
        env:
          PARENT_REPO: ${{ steps.extract.outputs.owner_repo }}
          PARENT_NUMBER: ${{ steps.extract.outputs.issue_num }}
          CHILD_REPO: ${{ github.repository }}
          CHILD_NUMBER: ${{ env.ISSUE_NUMBER }}
        run: |
          set -euo pipefail

          echo "Fetching node IDs..."
          PARENT_NODE_ID=$(gh issue view https://github.com/$PARENT_REPO/issues/$PARENT_NUMBER --json id --jq .id)
          CHILD_NODE_ID=$(gh issue view https://github.com/$CHILD_REPO/issues/$CHILD_NUMBER --json id --jq .id)

          echo "Linking child → parent..."
          gh api graphql \
            -H "GraphQL-Features: sub_issues" \
            -f query="
              mutation {
                addSubIssue(input: {
                  issueId: \"${PARENT_NODE_ID}\",
                  subIssueId: \"${CHILD_NODE_ID}\"
                }) {
                  issue { title }
                  subIssue { title }
                }
              }
            "

      #
      # 8. Append the clickable URL to the bottom of the issue body (idempotent)
      #
      - name: Append normalized URL to issue body (idempotent)
        if: steps.extract.outputs.issue_num != ''
        env:
          CHILD_REPO: ${{ github.repository }}
          CHILD_NUMBER: ${{ env.ISSUE_NUMBER }}
          REQUIRE_URL: ${{ steps.extract.outputs.requirement_url }}
        run: |
          set -euo pipefail

          echo "Fetching existing body..."
          gh api "repos/$CHILD_REPO/issues/$CHILD_NUMBER" --jq .body > body_current.txt || echo -n > body_current.txt

          sed -e '/<!--mxl:requirement:start-->/,/<!--mxl:requirement:end-->/d' body_current.txt > body_clean.txt

          printf "\n\n<!--mxl:requirement:start-->\n%s\n<!--mxl:requirement:end-->\n" "$REQUIRE_URL" >> body_clean.txt

          NEW_BODY="$(cat body_clean.txt)"

          echo "Updating issue body..."
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            "repos/$CHILD_REPO/issues/$CHILD_NUMBER" \
            -f body="$NEW_BODY"
